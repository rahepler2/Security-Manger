version: "3.8"

services:
  nexus:
    image: sonatype/nexus3:latest
    container_name: nexus
    ports:
      - "8081:8081"
    volumes:
      - nexus-data:/nexus-data
    environment:
      - INSTALL4J_ADD_VM_PARAMS=-Xms1200m -Xmx1200m
    networks:
      - security-net

  trivy-server:
    image: aquasecurity/trivy:latest
    container_name: trivy-server
    command: ["server", "--listen", "0.0.0.0:8080", "--cache-dir", "/var/trivy/cache"]
    ports:
      - "8080:8080"
    volumes:
      - trivy-cache:/var/trivy/cache
    networks:
      - security-net

  postgres:
    image: postgres:15
    container_name: trivy_pg
    environment:
      - POSTGRES_USER=${PG_USER:-trivy}
      - POSTGRES_PASSWORD=${PG_PASS:-trivy_pass}
      - POSTGRES_DB=${PG_DB:-trivydb}
    volumes:
      - pg-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - security-net

  minio:
    image: minio/minio:RELEASE.2023-11-14T02-37-10Z
    container_name: minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Console
    volumes:
      - minio-data:/data
    networks:
      - security-net

  grafana:
    image: grafana/grafana:9.5.6
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    ports:
      - "3000:3000"
    depends_on:
      - postgres
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - security-net

  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: orchestrator
    environment:
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - TRIVY_REMOTE=http://trivy-server:8080
      - NEXUS_BASE_URL=http://nexus:8081
      - NEXUS_API_USER=${NEXUS_API_USER:-admin}
      - NEXUS_API_PASS=${NEXUS_API_PASS:-admin123}
      - POLICY_SEVERITY_BLOCK=${POLICY_SEVERITY_BLOCK:-HIGH,CRITICAL}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${PG_DB:-trivydb}
      - POSTGRES_USER=${PG_USER:-trivy}
      - POSTGRES_PASS=${PG_PASS:-trivy_pass}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-trivy-reports}
    ports:
      - "5000:5000"
    depends_on:
      - trivy-server
      - nexus
      - postgres
      - minio
    volumes:
      - ./orchestrator/data:/data
    networks:
      - security-net

volumes:
  nexus-data:
  trivy-cache:
  pg-data:
  minio-data:
  grafana-data:

networks:
  security-net:
    driver: bridge
